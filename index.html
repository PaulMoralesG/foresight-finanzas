<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Foresight - Buddy Style</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2666/2666508.png">

    <!-- Google Font: Nunito (Rounded, friendly, Buddy-like) -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #F2F2F7; /* iOS Light Gray */
            color: #1C1C1E;
            -webkit-tap-highlight-color: transparent;
        }

        /* Buddy-style Aesthetics */
        .buddy-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            transition: transform 0.1s;
        }
        .buddy-card:active { transform: scale(0.98); }

        .buddy-input {
            background: #F2F2F7;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            color: #1C1C1E;
        }
        .buddy-input::placeholder { color: #AEAEB2; }
        .buddy-input:focus { outline: none; ring: 2px solid #007AFF; background: #fff; }

        .icon-squircle {
            width: 48px;
            height: 48px;
            border-radius: 16px; /* Squircle effect */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        /* Animations */
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        .hidden-view { display: none !important; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 0px; background: transparent; }

        /* Floating Button with gradient */
        .fab-gradient {
            background: linear-gradient(135deg, #007AFF, #5856D6);
            box-shadow: 0 8px 20px rgba(88, 86, 214, 0.4);
        }
    </style>
</head>
<body class="safe-area-inset-bottom">

    <!-- ======================= -->
    <!-- VISTA 1: LOGIN AMIGABLE -->
    <!-- ======================= -->
    <section id="login-view" class="min-h-screen flex flex-col items-center justify-center p-6 bg-white">
        <div class="w-full max-w-sm slide-up">
            <div class="flex justify-center mb-8">
                <div class="w-24 h-24 bg-blue-50 rounded-[30px] flex items-center justify-center text-blue-500 text-4xl shadow-sm">
                    
                </div>
            </div>
            <h1 class="text-3xl font-extrabold text-center mb-2 text-gray-900">Hola, amigo.</h1>
            <p class="text-center text-gray-400 font-semibold mb-10">Vamos a cuidar tu dinero.</p>

            <form id="auth-form" class="space-y-4" autocomplete="off">
                <input type="email" id="auth-email" required class="w-full p-4 bg-gray-100 rounded-2xl font-bold text-gray-700 outline-none focus:bg-white focus:ring-2 focus:ring-blue-500 transition-all" placeholder="Correo electr√≥nico" autocomplete="email">
                <input type="password" id="auth-password" required class="w-full p-4 bg-gray-100 rounded-2xl font-bold text-gray-700 outline-none focus:bg-white focus:ring-2 focus:ring-blue-500 transition-all" placeholder="Contrase√±a" autocomplete="new-password">
                
                <button type="submit" id="btn-auth-submit" class="w-full py-4 mt-4 bg-gray-900 text-white font-extrabold rounded-2xl shadow-lg hover:bg-black transition-transform active:scale-95">
                    Iniciar Sesi√≥n
                </button>
                <div class="text-center mt-4">
                    <button type="button" id="btn-auth-toggle" class="text-sm font-bold text-gray-400 hover:text-blue-500 transition-colors">
                        ¬øNo tienes cuenta? <span class="text-blue-600">Reg√≠strate aqu√≠</span>
                    </button>
                    <button type="button" id="btn-resend-verify" class="block w-full mt-3 text-xs font-bold text-orange-400 hover:text-orange-600 transition-colors hidden-view">
                        ¬øNo recibiste el correo? Reenviar confirmaci√≥n
                    </button>
                </div>
            </form>
        </div>
    </section>

    <!-- ======================= -->
    <!-- VISTA 2: APP PRINCIPAL (MODERN DASHBOARD) -->
    <!-- ======================= -->
    <section id="app-view" class="hidden-view pb-32 bg-gray-50 min-h-screen">
        
        <!-- Header: User & Actions -->
        <div class="px-6 pt-10 pb-4 flex justify-between items-center bg-white/80 backdrop-blur-md sticky top-0 z-30">
            <div class="flex flex-col">
                <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Hola,</span>
                <span class="font-black text-xl text-gray-800 leading-none" id="user-display">Usuario</span>
            </div>
            <div class="flex gap-3">
                <button onclick="toggleSummary(true)" class="w-10 h-10 rounded-full bg-white shadow-sm border border-gray-100 text-gray-400 hover:text-blue-600 hover:border-blue-200 transition flex items-center justify-center active:scale-95"><i class="fa-solid fa-chart-pie"></i></button>
                <button onclick="logout()" class="w-10 h-10 rounded-full bg-white shadow-sm border border-gray-100 text-gray-400 hover:text-red-500 hover:border-red-200 transition flex items-center justify-center active:scale-95"><i class="fa-solid fa-power-off"></i></button>
            </div>
        </div>

        <!-- MAIN SCROLLABLE -->
        <main class="px-5 max-w-md mx-auto space-y-6">
            
            <!-- Month Navigator (Capsule Style) -->
            <div class="flex justify-center slide-up">
                <div class="flex items-center bg-white rounded-full p-1 pl-2 pr-2 shadow-sm border border-gray-100">
                    <button onclick="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-400 transition"><i class="fa-solid fa-chevron-left text-xs"></i></button>
                    <div class="px-4 text-center min-w-[120px]">
                        <p id="month-display" class="text-sm font-black text-gray-800 capitalize leading-none">---</p>
                        <p id="transaction-count" class="text-[9px] font-bold text-gray-400 mt-0.5 uppercase">0 Reg.</p>
                    </div>
                    <button onclick="changeMonth(1)" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-400 transition"><i class="fa-solid fa-chevron-right text-xs"></i></button>
                </div>
            </div>

            <!-- HERO CARD (Modern Wallet Style) -->
            <div class="relative w-full h-48 rounded-[32px] p-6 text-white shadow-xl shadow-blue-500/20 overflow-hidden slide-up" style="background: linear-gradient(135deg, #2563eb, #1e40af);">
                <!-- Decorative Circles -->
                <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-10 -mt-10 blur-2xl"></div>
                <div class="absolute bottom-0 left-0 w-24 h-24 bg-black/10 rounded-full -ml-5 -mb-5 blur-xl"></div>
                
                <div class="relative z-10 flex flex-col justify-between h-full">
                    <div>
                        <p class="text-blue-200 text-xs font-bold uppercase tracking-widest mb-1">Saldo Disponible</p>
                        <h2 class="text-4xl font-extrabold tracking-tight" id="available-display">$0</h2>
                    </div>

                    <!-- Progress Bar for Budget -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-end text-xs font-bold text-blue-100">
                            <span>Gastado este mes</span>
                            <span id="spent-percent">0%</span>
                        </div>
                        <div class="w-full h-2 bg-black/20 rounded-full overflow-hidden">
                            <div id="budget-bar" class="h-full bg-white rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STATS ROW (Floating Pills) -->
            <div class="grid grid-cols-2 gap-4 slide-up" style="animation-delay: 0.1s;">
                <!-- Income Pill -->
                <div onclick="filterTransactions('income')" class="bg-white p-4 rounded-3xl shadow-sm border border-gray-100 flex items-center gap-3 cursor-pointer hover:border-green-200 transition group">
                    <div class="w-10 h-10 rounded-2xl bg-green-50 text-green-500 flex items-center justify-center text-lg group-hover:scale-110 transition"><i class="fa-solid fa-arrow-down"></i></div>
                    <div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Ingresos</p>
                        <p class="text-lg font-black text-gray-800 leading-tight" id="dash-income">$0</p>
                    </div>
                </div>
                <!-- Expense Pill -->
                <div onclick="filterTransactions('expense')" class="bg-white p-4 rounded-3xl shadow-sm border border-gray-100 flex items-center gap-3 cursor-pointer hover:border-red-200 transition group">
                    <div class="w-10 h-10 rounded-2xl bg-red-50 text-red-500 flex items-center justify-center text-lg group-hover:scale-110 transition"><i class="fa-solid fa-arrow-up"></i></div>
                    <div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Gastos</p>
                        <p class="text-lg font-black text-gray-800 leading-tight" id="dash-expense">$0</p>
                    </div>
                </div>
            </div>

            <!-- Quick Actions & Status -->
            <div class="grid grid-cols-[1.5fr,1fr] gap-3 slide-up" style="animation-delay: 0.15s;">
                <!-- Budget Setting -->
                <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 text-xs"><i class="fa-solid fa-bullseye"></i></div>
                        <div>
                            <p class="text-[9px] font-bold text-gray-400 uppercase">Meta / Presupuesto</p>
                            <input type="number" id="budget-input" class="text-sm font-black text-gray-800 w-24 outline-none placeholder-gray-300" placeholder="Definir...">
                        </div>
                    </div>
                </div>

                <!-- Report Button -->
                <button onclick="sendAlertEmail(true)" id="btn-email-report" class="bg-black text-white p-3 rounded-2xl shadow-lg shadow-gray-200 flex items-center justify-center gap-2 hover:bg-gray-800 active:scale-95 transition">
                    <i class="fa-solid fa-paper-plane text-xs"></i>
                    <div class="text-left leading-none">
                        <p class="text-[8px] font-bold text-gray-400 uppercase opacity-50">Reporte</p>
                        <p class="text-xs font-bold">Enviar</p>
                    </div>
                </button>
            </div>

            <!-- Transactions List -->
            <div class="pt-2">
                <div class="flex justify-between items-end mb-4 px-1 slide-up" style="animation-delay: 0.2s;">
                    <h3 id="transactions-title" class="font-black text-lg text-gray-800">Movimientos</h3>
                    <button onclick="filterTransactions('all')" id="transactions-subtitle" class="text-[10px] font-bold text-gray-400 bg-white border border-gray-100 px-3 py-1 rounded-full shadow-sm">Ver Todo</button>
                </div>

                <ul id="movements-list" class="space-y-3 pb-8 slide-up" style="animation-delay: 0.25s;">
                    <li id="empty-state" class="text-center py-12 opacity-40">
                        <div class="text-5xl mb-4 grayscale">üëª</div>
                        <p class="text-sm font-bold text-gray-400">Sin movimientos a√∫n</p>
                        <p class="text-xs text-gray-300 mt-1">Usa el bot√≥n + para empezar</p>
                    </li>
                    <!-- Items injected via JS -->
                </ul>
            </div>

        </main>

        <!-- Fixed Bottom Elements -->
        <div class="fixed bottom-0 w-full left-0 p-6 pointer-events-none flex justify-center bg-gradient-to-t from-gray-100 via-gray-50/90 to-transparent z-20 pt-24">
            <button onclick="openAddModal()" class="fab-gradient pointer-events-auto text-white w-16 h-16 rounded-full flex items-center justify-center text-2xl shadow-2xl shadow-blue-500/40 hover:scale-110 transition-transform active:scale-95">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

    </section>

    <!-- ======================= -->
    <!-- MODALES (Overlays) -->
    <!-- ======================= -->


    <!-- New Expense Modal -->
    <div id="expense-modal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center invisible opacity-0 transition-all duration-300">
        <div onclick="toggleModal(false)" class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity"></div>
        <form id="expense-form" class="bg-white w-full max-w-md sm:rounded-3xl rounded-t-3xl p-5 pb-12 shadow-2xl relative z-10 transform translate-y-full sm:translate-y-0 transition-transform duration-300 overflow-y-auto max-h-[85vh] sm:max-h-[90vh]">
            <div class="w-12 h-1 bg-gray-200 rounded-full mx-auto mb-4 sm:hidden"></div>
            
            <div class="flex justify-between items-center mb-4">
                <!-- TABS TIPO -->
                <div class="flex bg-gray-100 p-1 rounded-xl">
                    <button type="button" onclick="setTransactionType('expense')" id="btn-type-expense" class="px-4 py-1.5 rounded-lg text-sm font-extrabold shadow-sm bg-white text-black transition-all">Gasto</button>
                    <button type="button" onclick="setTransactionType('income')" id="btn-type-income" class="px-4 py-1.5 rounded-lg text-sm font-bold text-gray-500 hover:text-gray-700 transition-all">Ingreso</button>
                </div>
                <!-- Bot√≥n Eliminar (Hidden by default) -->
                <div class="flex items-center gap-2">
                    <button type="button" id="btn-delete" onclick="deleteTransaction()" class="hidden text-red-500 hover:bg-red-50 p-2 rounded-full transition-colors"><i class="fa-solid fa-trash"></i></button>
                    <button type="button" onclick="toggleModal(false)" class="text-gray-400 hover:text-gray-600 bg-gray-100 rounded-full w-8 h-8 flex items-center justify-center font-bold">‚úï</button>
                </div>
            </div>
            
            <input type="hidden" id="transaction-type" value="expense">
            <input type="hidden" id="editing-id" value="">

            <!-- Cantidad -->
            <div class="mb-4 relative">
                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold text-xl">$</span>
                <input type="number" id="amount" required step="0.01" min="0.01" class="w-full bg-gray-50 rounded-2xl py-2 pl-10 pr-4 text-3xl font-black text-gray-900 outline-none focus:ring-2 focus:ring-blue-500 transition-all placeholder-gray-300 text-center" placeholder="0">
            </div>

            <!-- Categor√≠a Grid -->
            <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Categor√≠a</label>
            <div class="grid grid-cols-4 gap-2 mb-4" id="category-grid">
                <!-- Se inyectan con JS -->
            </div>
            <input type="hidden" id="selected-category" value="Otros">

            <!-- Detalles -->
            <div class="space-y-3 mb-5">
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Nota</label>
                    <input type="text" id="concept" class="w-full bg-gray-50 rounded-xl px-3 py-2 font-bold text-gray-700 outline-none focus:ring-2 focus:ring-blue-500 transition-all placeholder-gray-400 text-sm" placeholder="¬øEn qu√© lo gastaste?">
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Fecha</label>
                        <input type="date" id="date" required class="w-full bg-gray-50 rounded-xl px-3 py-2 font-bold text-gray-700 outline-none focus:ring-2 focus:ring-blue-500 transition-all text-sm">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">M√©todo</label>
                        <select id="method" class="w-full bg-gray-50 rounded-xl px-3 py-2 font-bold text-gray-700 outline-none focus:ring-2 focus:ring-blue-500 transition-all appearance-none text-sm">
                            <option value="Efectivo">üíµ Efectivo</option>
                            <option value="Tarjeta">üí≥ Tarjeta</option>
                            <option value="Transferencia">üè¶ Transferencia</option>
                        </select>
                    </div>
                </div>
            </div>

            <button type="submit" class="w-full bg-black text-white font-extrabold py-3 rounded-2xl shadow-xl active:scale-95 transition-transform text-lg">
                Guardar
            </button>
        </form>
    </div>

    <!-- Summary Modal -->
    <div id="summary-modal" class="fixed inset-0 z-50 flex items-end justify-center invisible opacity-0 transition-all duration-300">
        <div onclick="toggleSummary(false)" class="absolute inset-0 bg-black/20 backdrop-blur-sm transition-opacity"></div>
        <div class="bg-white w-full max-w-md rounded-t-[30px] p-8 shadow-2xl relative z-10 transform translate-y-full transition-transform duration-300 h-[90vh] flex flex-col" id="summary-panel">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black text-gray-900">Tu Resumen</h3>
                <button onclick="toggleSummary(false)" class="bg-gray-100 w-10 h-10 rounded-full text-gray-500 hover:bg-gray-200"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto">
                <div class="bg-blue-50 p-6 rounded-3xl mb-4 border border-blue-100">
                    <p class="text-blue-500 font-bold text-xs uppercase mb-1">Gasto Total (Mes)</p>
                    <p class="text-4xl font-black text-blue-900" id="summary-total">$0</p>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-50 p-5 rounded-3xl">
                        <p class="text-gray-400 font-bold text-[10px] uppercase mb-1">Promedio Diario</p>
                        <p class="text-xl font-bold text-gray-800" id="summary-daily">$0</p>
                    </div>
                    <div class="bg-gray-50 p-5 rounded-3xl">
                        <p class="text-gray-400 font-bold text-[10px] uppercase mb-1">Proyecci√≥n Fin Mes</p>
                        <p class="text-xl font-bold text-gray-800" id="summary-proj">$0</p>
                    </div>
                </div>

                <!-- Secci√≥n Ahorros y Finanzas -->
                <div class="mt-6 border-t border-gray-100 pt-6">
                    <h4 class="font-extrabold text-gray-900 mb-4 flex items-center gap-2">
                        <span class="bg-green-100 text-green-600 p-1.5 rounded-lg text-sm">üê∑</span> 
                        Mis Ahorros & Futuro
                    </h4>
                    <div class="bg-green-50 p-6 rounded-3xl border border-green-100 mb-4 transition-all">
                        <div class="flex justify-between items-end mb-2">
                            <p class="text-green-600 font-bold text-xs uppercase">Est. Ahorro Fin de Mes</p>
                            <span class="text-xs font-bold text-green-700 bg-green-200 px-2 py-1 rounded-full" id="savings-status">---</span>
                        </div>
                        <p class="text-3xl font-black text-green-800" id="summary-savings">$0</p>
                        <p class="text-xs font-bold text-green-600 mt-2 opacity-80" id="savings-message">---</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal (Custom Style) -->
    <div id="delete-modal" class="fixed inset-0 z-[60] flex items-center justify-center invisible opacity-0 transition-all duration-300">
        <div onclick="toggleDeleteModal(false)" class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity"></div>
        <div class="bg-white w-full max-w-xs rounded-[30px] p-6 shadow-2xl relative z-10 transform scale-90 transition-transform duration-300 m-4" id="delete-panel">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center text-2xl text-red-500 mx-auto mb-4">
                    <i class="fa-solid fa-trash-can"></i>
                </div>
                <h3 class="text-xl font-black text-gray-900 mb-2">¬øBorrar esto?</h3>
                <p class="text-gray-400 text-xs font-bold leading-relaxed">Si lo borras, desaparecer√° de tus registros y estad√≠sticas para siempre.</p>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="toggleDeleteModal(false)" class="py-3 rounded-2xl font-extrabold text-xs text-gray-500 bg-gray-100 hover:bg-gray-200 transition">Cancelar</button>
                <button onclick="executeDelete()" id="btn-confirm-delete" class="py-3 rounded-2xl font-extrabold text-white bg-red-500 hover:bg-red-600 transition shadow-lg shadow-red-200 text-xs">S√≠, Borrar</button>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        const EMAILJS_PUBLIC_KEY = "jvOpRliw08hAwHWee";
        const EMAILJS_SERVICE_ID = "service_xfvaqua";
        const EMAILJS_TEMPLATE_ID = "template_hiw0fpp"; 

        // CONFIGURACI√ìN SERVICES
        const SUPABASE_URL = "https://sphmdtlvxbypckhavhgb.supabase.co"; 
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwaG1kdGx2eGJ5cGNraGF2aGdiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MTA3MTEsImV4cCI6MjA4NjQ4NjcxMX0.kBqqJpwtPL-W8YEGU9wdA3HvwBsL2-G4ZIv051StvrE";
        
        // Inicializar EmailJS
        emailjs.init(EMAILJS_PUBLIC_KEY);
        
        // Inicializar Supabase
        let supabaseClient = null;
        if (window.supabase) {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            // Escuchar cambios de sesi√≥n (Persistencia)
            supabaseClient.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN' || event === 'INITIAL_SESSION') {
                    if (session && session.user) {
                        // Solo cargar si no estamos ya logueados para evitar recargas innecesarias
                        if (!currentUser) {
                           console.log("Sesi√≥n recuperada:", session.user.email);
                           loadProfileFromSupabase(session.user.email);
                        }
                    }
                } else if (event === 'SIGNED_OUT') {
                    // logout() ya maneja la recarga, pero por seguridad:
                    if(currentUser) window.location.reload();
                }
            });

        } else {
            console.error("Error cr√≠tico: SDK de Supabase no cargado.");
        }

        // EMOJI HELPER & CONSTANTS
        const EXPENSE_CATEGORIES = [
            { id: 'comida', label: 'Comida', icon: 'üçî', color: 'bg-orange-100 text-orange-600' },
            { id: 'transporte', label: 'Transp.', icon: 'üöñ', color: 'bg-blue-100 text-blue-600' },
            { id: 'ocio', label: 'Ocio', icon: 'üéâ', color: 'bg-purple-100 text-purple-600' },
            { id: 'super', label: 'S√∫per', icon: 'üõí', color: 'bg-green-100 text-green-600' },
            { id: 'ropa', label: 'Ropa', icon: 'üëï', color: 'bg-pink-100 text-pink-600' },
            { id: 'casa', label: 'Casa', icon: 'üè†', color: 'bg-teal-100 text-teal-600' },
            { id: 'salud', label: 'Salud', icon: 'üíä', color: 'bg-red-100 text-red-600' },
            { id: 'educacion', label: 'Educ.', icon: 'üìö', color: 'bg-yellow-100 text-yellow-600' },
            { id: 'servicios', label: 'Servic.', icon: 'üí°', color: 'bg-gray-100 text-gray-600' },
            { id: 'suscrip', label: 'Subs', icon: 'üì∫', color: 'bg-indigo-100 text-indigo-600' },
            { id: 'viajes', label: 'Viajes', icon: '‚úàÔ∏è', color: 'bg-cyan-100 text-cyan-600' },
            { id: 'otros', label: 'Otros', icon: 'üí∏', color: 'bg-gray-100 text-gray-600' },
        ];

        const INCOME_CATEGORIES = [
            { id: 'sueldo', label: 'Sueldo', icon: 'üí∞', color: 'bg-green-100 text-green-600' },
            { id: 'negocio', label: 'Negocio', icon: 'üëî', color: 'bg-blue-100 text-blue-600' },
            { id: 'venta', label: 'Venta', icon: 'üè∑Ô∏è', color: 'bg-purple-100 text-purple-600' },
            { id: 'regalo', label: 'Regalo', icon: 'üéÅ', color: 'bg-pink-100 text-pink-600' },
            { id: 'inversion', label: 'Inversi√≥n', icon: 'üìà', color: 'bg-yellow-100 text-yellow-600' },
            { id: 'otros_ingreso', label: 'Otros', icon: '‚ûï', color: 'bg-gray-100 text-gray-600' },
        ];

        function getCategoryById(id) {
            const allCats = [...EXPENSE_CATEGORIES, ...INCOME_CATEGORIES];
            return allCats.find(c => c.id === id) || EXPENSE_CATEGORIES[EXPENSE_CATEGORIES.length - 1];
        }

        // STATE
        let currentUser = null; 
        let currentViewDate = new Date(); // Fecha para la vista actual (navegaci√≥n por meses)
        let state = { budget: 0, expenses: [] };
        let currentFilter = 'all';
        
        const DOM = {
            views: { login: document.getElementById('login-view'), app: document.getElementById('app-view') },
            auth: { 
                form: document.getElementById('auth-form'), 
                email: document.getElementById('auth-email'), 
                pass: document.getElementById('auth-password'),
                submitBtn: document.getElementById('btn-auth-submit'),
                toggleBtn: document.getElementById('btn-auth-toggle'),
                resendBtn: document.getElementById('btn-resend-verify')
            },
            
            // Stats Displays
            availableDisplay: document.getElementById('available-display'),
            dashIncome: document.getElementById('dash-income'),
            dashExpense: document.getElementById('dash-expense'),
            budgetBar: document.getElementById('budget-bar'),
            spentPercent: document.getElementById('spent-percent'),
            
            // Month Nav Elements
            monthDisplay: document.getElementById('month-display'),
            countDisplay: document.getElementById('transaction-count'),

            budgetInput: document.getElementById('budget-input'),
            movementsList: document.getElementById('movements-list'),
            emptyState: document.getElementById('empty-state'),
            modal: document.getElementById('expense-modal'),
            modalPanel: document.getElementById('modal-panel'),
            summary: {
                modal: document.getElementById('summary-modal'),
                panel: document.getElementById('summary-panel'),
                total: document.getElementById('summary-total'),
                daily: document.getElementById('summary-daily'),
                proj: document.getElementById('summary-proj'),
                savings: document.getElementById('summary-savings'),
                savingsStatus: document.getElementById('savings-status'),
                savingsMsg: document.getElementById('savings-message')
            },
            // statusCard: removed
            // statusText: removed
            // statusIcon: removed
            btnEmail: document.getElementById('btn-email-report'),
            userDisplay: document.getElementById('user-display'),
            // New Form elements
            categoryGrid: document.getElementById('category-grid'),
            selectedCategoryInput: document.getElementById('selected-category'),
            dateInput: document.getElementById('date'),
            typeInput: document.getElementById('transaction-type'),
            btnTypeExpense: document.getElementById('btn-type-expense'),
            btnTypeIncome: document.getElementById('btn-type-income'),
            editingIdInput: document.getElementById('editing-id'),
            btnDelete: document.getElementById('btn-delete'),
            amountInput: document.getElementById('amount'),
            conceptInput: document.getElementById('concept'),
            methodInput: document.getElementById('method')
        };

        // --- TYPE SWITCHER ---
        function setTransactionType(type) {
            DOM.typeInput.value = type;
            DOM.categoryGrid.style.display = 'grid'; // Asegurar que siempre se ve
            
            if(type === 'expense') {
                DOM.btnTypeExpense.className = "px-4 py-2 rounded-lg text-sm font-extrabold shadow-sm bg-white text-black transition-all";
                DOM.btnTypeIncome.className = "px-4 py-2 rounded-lg text-sm font-bold text-gray-500 hover:text-gray-700 transition-all";
                // Render Expense Categories
                initCategoryGrid(EXPENSE_CATEGORIES);
                DOM.conceptInput.placeholder = "¬øEn qu√© lo gastaste?";
            } else {
                DOM.btnTypeIncome.className = "px-4 py-2 rounded-lg text-sm font-extrabold shadow-sm bg-green-100 text-green-700 transition-all";
                DOM.btnTypeExpense.className = "px-4 py-2 rounded-lg text-sm font-bold text-gray-500 hover:text-gray-700 transition-all";
                // Render Income Categories
                initCategoryGrid(INCOME_CATEGORIES);
                DOM.conceptInput.placeholder = "¬øDe d√≥nde provino este dinero?";
            }
        }

        // --- INIT CATEGORY GRID ---
        function initCategoryGrid(categoriesToRender = EXPENSE_CATEGORIES) {
            DOM.categoryGrid ? DOM.categoryGrid.innerHTML = '' : null;
            if(!DOM.categoryGrid) return;
            
            categoriesToRender.forEach((cat, index) => {
                const btn = document.createElement('button');
                btn.type = 'button';
                // Usar clases condicionales se maneja en el click
                const isDefault = index === 0;
                btn.className = `flex flex-col items-center justify-center p-1 rounded-xl border-2 border-transparent transition-all ${isDefault ? 'bg-white shadow-md border-gray-200 transform scale-105' : 'bg-gray-50 hover:bg-gray-100'}`;
                
                // Si es el primero, marcarlo visualmente como seleccionado al inicio
                if (isDefault) {
                     // Solo visual, el selectCategory abajo har√° el trabajo l√≥gico
                }

                btn.innerHTML = `<span class="text-xl mb-0.5">${cat.icon}</span><span class="text-[9px] font-bold ${isDefault ? 'text-gray-900' : 'text-gray-500'} uppercase">${cat.label}</span>`;
                
                btn.onclick = () => selectCategory(cat.id, btn);
                DOM.categoryGrid.appendChild(btn);
            });
            // Select default (first one)
            if(categoriesToRender.length > 0) {
                 selectCategory(categoriesToRender[0].id, DOM.categoryGrid.firstChild);
            }
        }

        function selectCategory(id, btnElement) {
            DOM.selectedCategoryInput.value = id;
            // Reset visual state
            Array.from(DOM.categoryGrid.children).forEach(b => {
                b.className = 'flex flex-col items-center justify-center p-1 rounded-xl border-2 border-transparent bg-gray-50 hover:bg-gray-100 text-gray-400 transition-all opacity-60 grayscale';
            });
            // Highlight selected
            const cat = getCategoryById(id);
            btnElement.className = `flex flex-col items-center justify-center p-1 rounded-xl border-2 border-black bg-white shadow-md transition-all transform scale-105`;
            btnElement.innerHTML = `<span class="text-xl mb-0.5">${cat.icon}</span><span class="text-[9px] font-bold text-gray-900 uppercase">${cat.label}</span>`;
        }

        // --- AUTH ---
        // Helpers para manejar Perfiles y Auth de forma segura
        async function loadProfileFromSupabase(email) {
            let { data, error } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('email', email)
                .maybeSingle();

            if (error) throw error;
            
            // Auto-reparaci√≥n: Si el usuario existe en Auth pero no en la tabla profiles
            if (!data) {
                console.log("Perfil no encontrado en base de datos. Creando perfil inicial...");
                await createInitialProfile(email);
                
                // Intentar leer de nuevo
                const retry = await supabaseClient.from('profiles').select('*').eq('email', email).maybeSingle();
                data = retry.data;
                
                if (!data) {
                    throw new Error("Perfil no encontrado incluso despu√©s de intentar crearlo. Contacta a soporte.");
                }
            }
            
            login({ ...data, password: '' }); // Login exitoso
        }

        async function createInitialProfile(email) {
            // Verifica si ya existe data (migraci√≥n de usuarios viejos)
            const { data } = await supabaseClient.from('profiles').select('email').eq('email', email).maybeSingle();
            if (!data) {
                // Fix: Include a dummy password because the DB table has a NOT NULL constraint on 'password'
                // even though we don't use it (Auth handles it).
                const { error: insertError } = await supabaseClient
                    .from('profiles')
                    .insert([{ email, budget: 0, expenses: [], password: 'auth-managed' }]);
                
                if (insertError) {
                    console.error("Error creando perfil:", insertError);
                    throw new Error("No se pudo crear el perfil de usuario: " + insertError.message);
                }
            }
        }

        // AUTH LOGIC
        let isLoginMode = true;

        if (DOM.auth.toggleBtn) {
            DOM.auth.toggleBtn.addEventListener('click', () => {
                isLoginMode = !isLoginMode;
                if (isLoginMode) {
                   DOM.auth.submitBtn.textContent = "Iniciar Sesi√≥n";
                   DOM.auth.toggleBtn.innerHTML = '¬øNo tienes cuenta? <span class="text-blue-600">Reg√≠strate aqu√≠</span>';
                } else {
                   DOM.auth.submitBtn.textContent = "Crear Cuenta";
                   DOM.auth.toggleBtn.innerHTML = '¬øYa tienes cuenta? <span class="text-blue-600">Inicia sesi√≥n</span>';
                }
            });
        }

        if (DOM.auth.resendBtn) {
            DOM.auth.resendBtn.addEventListener('click', async () => {
                const email = DOM.auth.email.value.trim();
                if(!email) {
                    showNotification("Ingresa tu correo primero", 'error');
                    return;
                }
                
                // MODO NUBE
                if(supabaseClient) {
                   const btn = DOM.auth.resendBtn;
                   const old = btn.textContent;
                   btn.textContent = "Reenviando...";
                   btn.disabled = true;
                   
                   try {
                       const { error } = await supabaseClient.auth.resend({
                           type: 'signup',
                           email: email,
                           options: { emailRedirectTo: window.location.origin }
                       });
                       if(error) throw error;
                       showNotification("Correo reenviado. Revisa tu bandeja de entrada.", 'success');
                       btn.classList.add('hidden-view'); // Ocultar tras √©xito
                   } catch(err) {
                       console.error(err);
                       if(err.message.includes("rate limit")) showNotification("Demasiados intentos. Espera un momento.", 'error');
                       else showNotification("Error al reenviar: " + err.message, 'error');
                   } finally {
                       btn.textContent = old;
                       btn.disabled = false;
                   }
                }
            });
        }
        DOM.auth.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = DOM.auth.email.value.trim();
            const pass = DOM.auth.pass.value.trim();
            if(!email || !pass) {
                showNotification("Por favor completa todos los campos.", 'error');
                return;
            }

            // MODO NUBE (SUPABASE)
            if (supabaseClient) {
                if(DOM.auth.resendBtn) DOM.auth.resendBtn.classList.add('hidden-view'); // Reset UI
                
                const btn = DOM.auth.submitBtn;
                const oldText = btn.innerHTML;
                btn.textContent = isLoginMode ? "Verificando..." : "Registrando...";
                btn.disabled = true;

                try {
                    if (isLoginMode) {
                        // LOGIN EXACTO
                        const { error } = await supabaseClient.auth.signInWithPassword({ email, password: pass });
                        if (error) throw error;
                        await loadProfileFromSupabase(email);
                    } else {
                        // REGISTRO EXACTO
                        const { data, error } = await supabaseClient.auth.signUp({ 
                            email, 
                            password: pass,
                            options: { emailRedirectTo: window.location.origin }
                        });
                        if (error) throw error;
                        
                        if (data.user && !data.session) {
                             showNotification("Registro exitoso. Revisa tu correo para confirmar.", 'success');
                             return; 
                        }

                        if (data.user) {
                           await createInitialProfile(email);
                           await loadProfileFromSupabase(email);
                        }
                    }
                } catch (err) {
                    console.error("Error Auth:", err);
                    let msg = err.message;
                    if (msg.includes("security purposes")) msg = "Por seguridad, espera unos segundos antes de intentar de nuevo.";
                    else if (msg.includes("Invalid login")) {
                        msg = "Credenciales incorrectas.";
                        // Si falla el login, damos la opci√≥n de reenviar confirmaci√≥n por si acaso
                        if(DOM.auth.resendBtn) DOM.auth.resendBtn.classList.remove('hidden-view');
                    }
                    else if (msg.includes("already registered")) msg = "Este correo ya est√° registrado.";
                    else if (msg.includes("rate limit exceeded") || msg.includes("email rate limit")) msg = "Demasiados intentos. Por favor espera un momento antes de volver a intentar.";
                    else if (msg.includes("Email not confirmed")) {
                        msg = "Tu correo no ha sido confirmado. Por favor revisa tu bandeja de entrada.";
                        if(DOM.auth.resendBtn) DOM.auth.resendBtn.classList.remove('hidden-view');
                    }
                    showNotification(msg, 'error');
                } finally {
                    btn.innerHTML = oldText;
                    btn.disabled = false;
                }
                return;
            }

            // MODO LOCAL (LEGACY)
            const userKey = `foresight_user_${email}`;
            const stored = localStorage.getItem(userKey);

            if (isLoginMode) {
                if (stored) {
                    const data = JSON.parse(stored);
                    if (data.password === pass) login(data);
                    else showNotification('Contrase√±a incorrecta', 'error');
                } else {
                    showNotification("Usuario no encontrado. Por favor, reg√≠strese.", 'error');
                }
            } else {
                if (stored) {
                    showNotification("El usuario ya existe. Por favor inicie sesi√≥n.", 'error');
                } else {
                    const newUser = { email, password: pass, budget: 0, expenses: [] };
                    localStorage.setItem(userKey, JSON.stringify(newUser));
                    login(newUser);
                }
            }
        });

        function login(userData) {
            currentUser = userData;
            state.budget = userData.budget;
            state.expenses = userData.expenses || [];
            
            DOM.views.login.classList.add('hidden-view');
            DOM.views.app.classList.remove('hidden-view');
            DOM.userDisplay.textContent = currentUser.email.split('@')[0];
            DOM.budgetInput.value = state.budget || '';
            
            initCategoryGrid(); // Load categories
            updateUI();
        }

        async function logout() {
            if (supabaseClient) {
                await supabaseClient.auth.signOut();
            }
            currentUser = null;
            location.reload(); 
        }

        async function saveData() {
            if (!currentUser) return false;
            
            // Sincronizar estado local con objeto de usuario
            currentUser.budget = state.budget;
            currentUser.expenses = state.expenses;
            
            try {
                // GUARDAR EN SUPABASE
                if (supabaseClient) {
                    const { error } = await supabaseClient
                        .from('profiles')
                        .update({ 
                            budget: state.budget, 
                            expenses: state.expenses 
                        })
                        .eq('email', currentUser.email);
                    
                    if (error) throw error;
                } else {
                    // GUARDAR LOCAL
                    localStorage.setItem(`foresight_user_${currentUser.email}`, JSON.stringify(currentUser));
                    // Simular peque√±o delay para UX
                    await new Promise(r => setTimeout(r, 500));
                }
                
                updateUI();
                return true; // √âxito
            } catch (err) {
                console.error("Error al guardar:", err);
                alert("Error al sincronizar con la nube. Revisa tu conexi√≥n.");
                return false; // Fallo
            }
        }

        // --- NAVIGATION ---
        function changeMonth(step) {
            // Update current View Date
            currentViewDate.setMonth(currentViewDate.getMonth() + step);
            // Refresh visuals
            updateUI();
        }

        // --- CORE LOGIC ---
        function getMonthlyData() {
            // Filter using currentViewDate instead of now
            const viewMonth = currentViewDate.getMonth();
            const viewYear = currentViewDate.getFullYear();

            return state.expenses.filter(item => {
                const d = new Date(item.date);
                // Adjust for timezone offset ish or just use simple month/year check
                // Dates are saved as ISO strings usually
                // Simple assumption: saved dates are correct in UTC/ISO
                return d.getMonth() === viewMonth && d.getFullYear() === viewYear;
            });
        }

        function calculateProjection(totalSpent) {
            // Proyection only makes sense for CURRENT month
            const now = new Date();
            if(now.getMonth() !== currentViewDate.getMonth() || now.getFullYear() !== currentViewDate.getFullYear()) {
                return totalSpent; // No projection for past/future months, show actual
            }

            const date = new Date();
            const day = Math.max(1, date.getDate());
            return (totalSpent / day) * 30; 
        }

        function updateUI() {
            // 0. Update Header Date
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            DOM.monthDisplay.textContent = `${monthNames[currentViewDate.getMonth()]} ${currentViewDate.getFullYear()}`;
            
            // 1. Get Data
            const monthlyData = getMonthlyData();
            DOM.countDisplay.textContent = `${monthlyData.length} Reg.`;

            // Separar Gastos e Ingresos
            const incomeItems = monthlyData.filter(i => i.type === 'income');
            const expenseItems = monthlyData.filter(i => i.type === 'expense' || !i.type);

            const totalIncome = incomeItems.reduce((sum, item) => sum + item.amount, 0);
            const totalSpent = expenseItems.reduce((sum, item) => sum + item.amount, 0);
            
            // F√≥rmula: Saldo = (Presupuesto + Ingresos) - Gastado
            const available = (state.budget + totalIncome) - totalSpent; 

            // 1. Available/Saldo Hero
            DOM.availableDisplay.textContent = formatMoney(available);
            
            // 1.1 Dashboard Mini-Cards
            DOM.dashIncome.textContent = formatMoney(totalIncome);
            DOM.dashExpense.textContent = formatMoney(totalSpent);
            
            // 2. Budget Bar Logic
            const totalCapacity = state.budget + totalIncome;
            let percent = 0;
            
            if (totalCapacity > 0) {
                percent = Math.min((totalSpent / totalCapacity) * 100, 100);
            } else if (totalSpent > 0) {
                // Si no hay presupuesto ni ingresos pero hay gastos -> 100%
                percent = 100;
            }

            // Update Bar visual
            DOM.spentPercent.textContent = `${Math.round(percent)}%`;
            DOM.budgetBar.style.width = `${percent}%`;
            
            // Colores Din√°micos de la Barra
            DOM.budgetBar.className = 'h-full rounded-full transition-all duration-1000 ease-out';
            if(percent > 100) {
                 DOM.budgetBar.classList.add('bg-red-500'); // Over budget
            } else if (percent > 85) {
                DOM.budgetBar.classList.add('bg-yellow-400'); // Warning
            } else {
                DOM.budgetBar.classList.add('bg-white'); // Healthy
            }

            // 3. List
            let itemsToShow = monthlyData;
            if (currentFilter === 'income') itemsToShow = incomeItems;
            if (currentFilter === 'expense') itemsToShow = expenseItems;

            renderList(itemsToShow);
            updateFilterHeader();
        }

        function filterTransactions(type) {
            if (type === 'all') {
                currentFilter = 'all';
            } else if (currentFilter === type) {
                currentFilter = 'all'; // Toggle off if clicked again
            } else {
                currentFilter = type;
            }
            updateUI();
        }

        function updateFilterHeader() {
            const title = document.getElementById('transactions-title');
            const badge = document.getElementById('transactions-subtitle');
            
            if(!title || !badge) return;

            // Reset base classes
            badge.className = 'text-[10px] font-bold px-2 py-0.5 rounded-md transition-colors'; 

            if(currentFilter === 'income') {
                title.textContent = 'Ingresos';
                title.className = 'font-extrabold text-base text-green-600';
                badge.textContent = 'Ver Todos';
                badge.classList.add('bg-green-100', 'text-green-600');
            } else if(currentFilter === 'expense') {
                title.textContent = 'Gastos';
                title.className = 'font-extrabold text-base text-red-600';
                badge.textContent = 'Ver Todos';
                badge.classList.add('bg-red-100', 'text-red-600');
            } else {
                title.textContent = 'Transacciones';
                title.className = 'font-extrabold text-base text-gray-900';
                badge.textContent = 'Este Mes';
                badge.classList.add('text-gray-400', 'bg-gray-100');
            }
        }

        function setCardStatus(text, icon, borderClass, bgClass, textClass) {
            DOM.statusCard.className = `buddy-card px-3 py-2 flex items-center justify-between border-l-2 ${borderClass} ${bgClass} shadow-sm`;
            DOM.statusText.textContent = text;
            DOM.statusText.className = `text-sm font-black leading-none ${textClass}`;
            DOM.statusIcon.textContent = icon;
            DOM.statusIcon.className = `text-lg w-6 h-6 flex items-center justify-center rounded-full bg-white/50`;
        }

        function renderList(items) {
            Array.from(DOM.movementsList.children).forEach(child => {
                if (child.id !== 'empty-state') child.remove();
            });

            if (items.length === 0) {
                DOM.emptyState.style.display = 'block';
            } else {
                DOM.emptyState.style.display = 'none';
                [...items].reverse().forEach(exp => {
                    // Logic para Tipo
                    const isIncome = exp.type === 'income';
                    
                    // Categor√≠a
                    const catId = exp.category || (isIncome ? 'otros' : 'otros');
                    // Podr√≠amos tener icono especial para ingresos gen√©ricos si no hay categor√≠a
                    let catData = getCategoryById(catId);
                    
                    if(isIncome && catId === 'otros') {
                        catData = { label: 'Ingreso', icon: 'üí∞', color: 'bg-green-100 text-green-700' };
                    }


                    // Si es Ingreso y no hay categor√≠a definida, mostrar 'Ingreso' como label base,
                    // PERO si hay concepto, queremos ver el concepto como t√≠tulo principal
                    
                    let mainTitle = catData.label;
                    let subTitle = `${exp.concept || (isIncome ? 'Ingreso Extra' : 'Sin descripci√≥n')}`;
                    
                    // Mejor UX: Si hay un concepto escrito por el usuario, mostrarlo como t√≠tulo principal
                    if (exp.concept && exp.concept.length > 0) {
                        mainTitle = exp.concept;
                        subTitle = catData.label; // La categor√≠a pasa a ser subt√≠tulo
                    }
                    
                    // Si es ingreso gen√©rico (cat 'otros') y tiene concepto, el icono ya es üí∞
                    // Si no tiene concepto, mainTitle ser√° "Ingreso" o "Comida" etc.

                    const li = document.createElement('li');
                    li.className = 'buddy-card p-4 flex justify-between items-center slide-up group cursor-pointer hover:bg-gray-50 transition-colors active:scale-95';
                    li.onclick = () => editTransaction(exp.id); // Click to Edit
                    
                    const amountClass = isIncome ? 'text-green-600' : 'text-gray-900';
                    const sign = isIncome ? '+' : '-';

                    li.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="icon-squircle text-2xl ${catData.color ?? 'bg-gray-100'}">${catData.icon}</div>
                            <div class="min-w-0 flex-1">
                                <p class="font-bold text-gray-800 leading-tight truncate pr-2">${mainTitle}</p>
                                <p class="text-xs font-bold text-gray-400 mt-0.5 truncate">
                                    ${subTitle} ‚Ä¢ ${exp.method || 'Efectivo'}
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 shrink-0">
                             <div class="text-right">
                                 <span class="font-extrabold ${amountClass} text-lg block">${sign}${formatMoney(exp.amount)}</span>
                                 <span class="text-[10px] font-bold text-gray-400 opacity-60">${new Date(exp.date).toLocaleDateString()}</span>
                             </div>
                             <div class="w-6 h-6 rounded-full bg-gray-50 text-gray-300 flex items-center justify-center text-[10px]"><i class="fa-solid fa-pen"></i></div>
                        </div>
                    `;
                    DOM.movementsList.appendChild(li);
                });
            }
        }

        // --- EDIT & DELETE LOGIC ---
        function openAddModal() {
            // Limpia todo antes de abrir para "Nuevo"
            DOM.editingIdInput.value = '';
            document.getElementById('expense-form').reset();
            DOM.btnDelete.classList.add('hidden'); 
            setTransactionType('expense');
            if(DOM.dateInput) DOM.dateInput.valueAsDate = new Date();
            selectCategory('comida', DOM.categoryGrid.firstChild); 
            
            toggleModal(true);
        }

        function editTransaction(id) {
            const item = state.expenses.find(i => i.id === id);
            if(!item) return;

            // Pre-fill form
            DOM.editingIdInput.value = item.id;
            DOM.amountInput.value = item.amount;
            DOM.conceptInput.value = item.concept;
            DOM.methodInput.value = item.method || 'Efectivo';
            
            // Handle Date (ISO to YYYY-MM-DD)
            try {
                const dateObj = new Date(item.date);
                const isoDate = dateObj.toISOString().split('T')[0];
                DOM.dateInput.value = isoDate;
            } catch(e) { DOM.dateInput.valueAsDate = new Date(); }

            // Handle Type & Category
            const type = item.type || 'expense';
            setTransactionType(type);
            
            // Restore Category Selection
            const catId = item.category || (type === 'income' ? 'otros_ingreso' : 'otros');
            const targetList = type === 'income' ? INCOME_CATEGORIES : EXPENSE_CATEGORIES;
            const catIndex = targetList.findIndex(c => c.id === catId);
            
            if (catIndex >= 0 && DOM.categoryGrid.children[catIndex]) {
                selectCategory(catId, DOM.categoryGrid.children[catIndex]);
            } else if (DOM.categoryGrid.children.length > 0) {
                 // Fallback to first
                 selectCategory(targetList[0].id, DOM.categoryGrid.children[0]);
            }

            DOM.btnDelete.classList.remove('hidden'); // Show delete button
            toggleModal(true);
        }

        function deleteTransaction() {
            toggleDeleteModal(true);
        }

        async function executeDelete() {
            const id = parseInt(DOM.editingIdInput.value);
            if(!id) return;
            
            const btn = document.getElementById('btn-confirm-delete');

            await runAsyncAction(btn, async () => {
                const originalList = [...state.expenses];
                // Actualizar estado local
                state.expenses = state.expenses.filter(i => i.id !== id);
                
                // Sincronizar
                const success = await saveData();
                
                if(success) {
                    toggleDeleteModal(false);
                    toggleModal(false); // Close parent edit modal too
                } else {
                    // Revertir si fall√≥
                    state.expenses = originalList;
                }
            }, "Borrando...");
        }

        // --- TOGGLES ---
        function toggleDeleteModal(show) {
            const modal = document.getElementById('delete-modal');
            const panel = document.getElementById('delete-panel');
            if(show) {
                modal.classList.remove('invisible', 'opacity-0');
                panel.classList.remove('scale-90');
                panel.classList.add('scale-100');
            } else {
                modal.classList.add('invisible', 'opacity-0');
                panel.classList.remove('scale-100');
                panel.classList.add('scale-90');
            }
        }

        // Helper para botones con estado de carga
        async function runAsyncAction(btnElement, asyncFn, loadingText = "Procesando...") {
            const originalText = btnElement.innerHTML; // Guardar icono/texto original
            // Si es input/button
            if(btnElement.tagName === 'INPUT') btnElement.value = loadingText;
            else btnElement.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> ${loadingText}`; // Spinner FontAwesome
            
            btnElement.disabled = true;
            
            try {
                await asyncFn();
            } finally {
                // Restaurar bot√≥n
                if(btnElement.tagName === 'INPUT') btnElement.value = originalText;
                else btnElement.innerHTML = originalText;
                btnElement.disabled = false;
            }
        }

        // --- ACTIONS ---
        DOM.budgetInput.addEventListener('change', async (e) => {
            state.budget = parseFloat(e.target.value) || 0;
            // Indicador visual simple para el presupuesto
            e.target.classList.add('bg-blue-100');
            await saveData();
            e.target.classList.remove('bg-blue-100');
        });

        document.getElementById('expense-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btnSubmit = e.target.querySelector('button[type="submit"]');
            
            await runAsyncAction(btnSubmit, async () => {
                const concept = document.getElementById('concept').value;
                const amount = parseFloat(document.getElementById('amount').value);
                const category = document.getElementById('selected-category').value;
                const dateVal = document.getElementById('date').value;
                const method = document.getElementById('method').value;
                const type = document.getElementById('transaction-type').value; 
                const editingId = DOM.editingIdInput.value ? parseInt(DOM.editingIdInput.value) : null;

                if (amount > 0) {
                    let finalDate = new Date();
                    if(dateVal) {
                        const [y, m, d] = dateVal.split('-').map(Number);
                        finalDate = new Date(y, m-1, d, 12, 0, 0); 
                    }

                    const transactionData = { 
                        id: editingId || Date.now(), 
                        concept: concept || (type === 'income' ? 'Ingreso' : 'Gasto'), 
                        amount, 
                        category,
                        method,
                        type,
                        date: finalDate.toISOString() 
                    };

                    const originalList = [...state.expenses]; // Backup

                    if (editingId) {
                        const index = state.expenses.findIndex(i => i.id === editingId);
                        if(index !== -1) state.expenses[index] = transactionData;
                    } else {
                        state.expenses.push(transactionData);
                    }
                    
                    const success = await saveData();
                    
                    if (success) {
                        toggleModal(false);
                        e.target.reset();
                        setTransactionType('expense');
                        if(DOM.dateInput) DOM.dateInput.valueAsDate = new Date();
                    } else {
                        // Revertir cambios si fall√≥ la nube
                        state.expenses = originalList;
                    }
                }
            }, "Guardando...");
        });

        // MODAL TOGGLES
        function toggleModal(show) {
            const modal = DOM.modal;
            const panel = document.getElementById('expense-form');
            if(show) {
                // If opening NOT for edit (no ID pre-filled in previous steps), reset ID
                // But wait, editTransaction calls toggleModal(true) AFTER setting ID
                // So here we only reset if we are opening "fresh"
                // Check if we are being called from the "+" button (HTML onclick)
                // We'll handle cleanup in the 'else' (close) or external caller
                // Better: The + button onclick should clear editingId
                
                modal.classList.remove('invisible', 'opacity-0');
                if(window.innerWidth < 640) {
                     panel.classList.remove('translate-y-full');
                } else { 
                    panel.classList.remove('scale-95');
                    setTimeout(()=>document.getElementById('amount').focus(), 100);
                }
            } else {
                modal.classList.add('invisible', 'opacity-0');
                if(window.innerWidth < 640) panel.classList.add('translate-y-full');
                else panel.classList.add('scale-95');
                
                // CLEANUP AFTER CLOSE
                setTimeout(() => {
                    DOM.editingIdInput.value = '';
                    document.getElementById('expense-form').reset();
                    DOM.btnDelete.classList.add('hidden'); // Hide delete button
                    setTransactionType('expense');
                    DOM.dateInput.valueAsDate = new Date();
                    // Select default category visually
                    selectCategory('comida', DOM.categoryGrid.firstChild);
                }, 300);
            }
        }

        function toggleSummary(show) {
            const monthly = getMonthlyData();
            
            // Fix: Separate Income vs Expense for accurate totals
            const expensesOnly = monthly.filter(i => i.type === 'expense' || !i.type);
            const incomeOnly = monthly.filter(i => i.type === 'income');

            const totalSpent = expensesOnly.reduce((s, i) => s + i.amount, 0);
            const totalIncome = incomeOnly.reduce((s, i) => s + i.amount, 0);

            // LOGICA MEJORADA DE FECHAS
            const now = new Date();
            const viewingMonth = currentViewDate.getMonth();
            const viewingYear = currentViewDate.getFullYear();
            const isCurrentMonth = (now.getMonth() === viewingMonth) && (now.getFullYear() === viewingYear);
            
            // D√≠as totales del mes visualizado
            const daysInMonth = new Date(viewingYear, viewingMonth + 1, 0).getDate();
            
            // D√≠a para dividir (si es mes actual, usamos el d√≠a de hoy, si es pasado, usamos total d√≠as)
            let dayDivisor = isCurrentMonth ? Math.max(1, now.getDate()) : daysInMonth;
            
            // Promedio Diario
            const dailyAvg = totalSpent / dayDivisor;

            // Proyecci√≥n de Gasto Final
            // Si es mes pasado, la proyecci√≥n ES el gasto real. Si es actual, proyectamos linearmente.
            const projectionSpent = isCurrentMonth ? (dailyAvg * daysInMonth) : totalSpent;
            
            // Capacidad Financiera (Prioriza Presupuesto Fijo, si es 0 usa Ingresos Reales)
            // Si el usuario puso presupuesto $0, asumimos que su l√≠mite son sus ingresos.
            const totalCapacity = state.budget > 0 ? state.budget : totalIncome;
            
            // Ahorro Proyectado: Lo que tengo (o puedo gastar) MENOS lo que voy a terminar gastando
            const projectedSavings = totalCapacity - projectionSpent;

            if(show) {
                DOM.summary.total.textContent = formatMoney(totalSpent);
                DOM.summary.daily.textContent = formatMoney(dailyAvg);
                DOM.summary.proj.textContent = formatMoney(projectionSpent); 

                // Ajustar etiquetas si es mes pasado
                const labelProj = document.querySelector("#summary-panel p:nth-of-type(3)"); // Selector aprox para "PROYECCI√ìN FIN MES"
                if(labelProj) {
                    // Buscar el elemento span o p hermano anterior que contiene el texto del t√≠tulo
                    // Estructura actual: div > p (titulo) > p (monto)
                    // No tenemos IDs espec√≠ficos para los t√≠tulos, asumimos por orden o inyectamos l√≥gica simple
                    // Mejor: Dejamos el texto gen√©rico "PROYECCI√ìN / FINAL" si se desea, o lo cambiamos din√°micamente
                }
                
                // --- LOGICA AHORROS ---
                DOM.summary.savings.textContent = formatMoney(projectedSavings);

                if (projectedSavings >= 0) {
                    DOM.summary.savings.classList.remove('text-red-800');
                    DOM.summary.savings.classList.add('text-green-800');
                    
                    DOM.summary.savingsStatus.textContent = "Super√°vit";
                    DOM.summary.savingsStatus.className = "text-xs font-bold text-green-700 bg-green-200 px-2 py-1 rounded-full";
                    DOM.summary.savingsMsg.textContent = isCurrentMonth 
                        ? "¬°Bien! A este ritmo te sobrar√° dinero." 
                        : "Cerraste el mes con saldo positivo.";
                } else {
                    DOM.summary.savings.classList.remove('text-green-800');
                    DOM.summary.savings.classList.add('text-red-800');

                    DOM.summary.savingsStatus.textContent = "D√©ficit";
                    DOM.summary.savingsStatus.className = "text-xs font-bold text-red-700 bg-red-200 px-2 py-1 rounded-full";
                    DOM.summary.savingsMsg.textContent = isCurrentMonth 
                        ? "Cuidado: Vas camino a gastar m√°s de lo que tienes." 
                        : "Gastaste m√°s de lo disponible este mes.";
                }
                // ---------------------

                DOM.summary.modal.classList.remove('invisible', 'opacity-0');
                DOM.summary.panel.classList.remove('translate-y-full');
            } else {
                DOM.summary.modal.classList.add('invisible', 'opacity-0');
                DOM.summary.panel.classList.add('translate-y-full');
            }
        }

        // EMAIL FUNCTION
        async function sendAlertEmail(manual) {
            if (!currentUser || !currentUser.email) return;
            const monthly = getMonthlyData();
            
            // 1. Calcular Gastos e Ingresos
            const expensesOnly = monthly.filter(i => i.type === 'expense' || !i.type);
            const incomeOnly = monthly.filter(i => i.type === 'income');

            const totalSpent = expensesOnly.reduce((s, i) => s + i.amount, 0);
            const totalIncome = incomeOnly.reduce((s, i) => s + i.amount, 0);
            
            // 2. Definir "L√≠mite" Inteligente
            // Si hay presupuesto definido, √∫salo. Si es 0, usa el Total de Ingresos como l√≠mite.
            let limit = state.budget;
            let limitSource = "Presupuesto";
            
            if (limit <= 0 && totalIncome > 0) {
                limit = totalIncome;
                limitSource = "Ingresos (Auto)";
            }

            // 3. Calcular Proyecci√≥n a Fin de Mes
            const projection = calculateProjection(totalSpent);
            
            // 4. Determinar Estado
            let status = "Neutro";
            if (limit > 0) {
                if (totalSpent > limit) status = "üõë L√≠mite Excedido";
                else if (projection > limit) status = "‚ö†Ô∏è Cuidado (Proyecci√≥n Alta)";
                else status = "‚úÖ Saludable";
            } else {
                status = "‚ÑπÔ∏è Solo Registro";
            }

            // C√°lculo de Sobrante Proyectado (Proyecci√≥n Real)
            // ¬øCu√°nto me sobrar√° a fin de mes si sigo as√≠? = L√≠mite - Proyecci√≥n
            const projectedLeftover = limit > 0 ? (limit - projection) : 0;

            const btn = DOM.btnEmail;
            const label = btn.querySelector('p:nth-child(2)');
            const originalText = label.textContent;
            label.textContent = 'Enviando...';
            btn.disabled = true;

            try {
                await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
                    to_email: currentUser.email,
                    user_name: currentUser.email.split('@')[0],
                    total_spent: formatMoney(totalSpent),
                    // Enviamos el l√≠mite efectivo (sea presupuesto o ingresos)
                    budget_limit: formatMoney(limit), 
                    financial_status: status,
                    // Enviamos el sobrante proyectado real
                    projected_balance: formatMoney(projectedLeftover) 
                });
                showNotification('¬°Enviado! üöÄ', 'success');
            } catch (error) {
                console.error(error);
                showNotification("Error t√©cnico al enviar.", 'error');
            } finally {
                label.textContent = originalText;
                btn.disabled = false;
            }
        }

        function formatMoney(amount) {
            return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN', maximumFractionDigits: 0 }).format(amount);
        }

        // --- TOAST NOTIFICATIONS ---
        function showNotification(message, type = 'info') {
            // Remove existing toasts
            const existing = document.getElementById('toast-notification');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.id = 'toast-notification';
            toast.className = `fixed top-6 left-1/2 transform -translate-x-1/2 z-50 flex items-center w-full max-w-xs p-4 space-x-3 text-gray-500 bg-white rounded-lg shadow-2xl slide-up border-l-4 ${type === 'error' ? 'border-red-500' : 'border-blue-500'}`;
            
            let icon = type === 'error' ? '<i class="fa-solid fa-circle-exclamation text-red-500 text-lg"></i>' : '<i class="fa-solid fa-circle-check text-blue-500 text-lg"></i>';

            toast.innerHTML = `
                ${icon}
                <div class="pl-2 text-sm font-bold text-gray-800">${message}</div>
            `;

            document.body.appendChild(toast);

            // Audio feedback (optional, subtle click)
            // const audio = new Audio('path/to/sound.mp3'); audio.play().catch(e=>{});

            setTimeout(() => {
                toast.classList.remove('slide-up');
                toast.style.opacity = '0';
                toast.style.transform = 'translate(-50%, -20px)';
                toast.style.transition = 'all 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
    </script>
</body>
</html>
